rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if a user is the owner of a document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Rules for the 'users' collection
    match /users/{userId} {
      // Anyone can read a user's public profile
      allow get: if isAuthenticated();

      // A user can create their own document
      allow create: if isOwner(userId);
      
      // A user can only update specific fields on their own document
      allow update: if isOwner(userId) && request.resource.data.keys().hasOnly([
        'name', 'bio', 'location', 'avatarUrl', 'friends', 'blockedUsers', 'notificationSettings', 'fcmToken'
      ]);

      // Users cannot be deleted for now
      allow delete: if false;
    }
    
    // Rules for the 'posts' collection
    match /posts/{postId} {
      // Any authenticated user can read any post
      allow get, list: if isAuthenticated();

      // Only authenticated users can create posts
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);

      // The owner of the post can update it.
      // Any authenticated user can update the likedBy, attendees, or commentCount fields.
      allow update: if isAuthenticated() && 
                      (isOwner(resource.data.userId) ||
                       (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likedBy'])) ||
                       (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attendees'])) ||
                       (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['commentCount']) &&
                        request.resource.data.commentCount == resource.data.commentCount + 1)
                      );

      // The owner of the post can delete it
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);

      // Rules for 'comments' subcollection
      match /comments/{commentId} {
        // Any authenticated user can read comments
        allow get, list: if isAuthenticated();
        
        // Any authenticated user can create a comment
        allow create: if isAuthenticated() && isOwner(request.resource.data.userId);

        // A user can update the reactions on a comment
        allow update: if isAuthenticated() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions']);
        
        // The comment owner or post owner can delete a comment
        allow delete: if isAuthenticated() && (isOwner(resource.data.userId) || isOwner(get(/databases/$(database)/documents/posts/$(postId)).data.userId));
      }
    }

    // Rules for the 'businesses' collection
    match /businesses/{businessId} {
        // Any authenticated user can view business listings
        allow list, get: if isAuthenticated();
        
        // Any authenticated user can create a business listing
        allow create: if isAuthenticated() && isOwner(request.resource.data.ownerId);

        // Only the owner can update their business listing
        allow update: if isAuthenticated() && isOwner(resource.data.ownerId);

        // Only the owner can delete their business listing
        allow delete: if isAuthenticated() && isOwner(resource.data.ownerId);
    }
    
    // Rules for 'friend_requests' collection
    match /friend_requests/{requestId} {
      // A user can read a request if they are a participant
      allow get: if isAuthenticated() && request.auth.uid in resource.data.participantIds;
      
      // A user can create a request if they are the sender
      allow create: if isAuthenticated() && isOwner(request.resource.data.fromUserId);

      // The recipient can update the status of the request
      allow update: if isAuthenticated() && 
                      isOwner(resource.data.toUserId) && 
                      request.resource.data.status != resource.data.status;
                      
      // A user can delete a request if they are a participant
      allow delete: if isAuthenticated() && request.auth.uid in resource.data.participantIds;
    }

    // Rules for 'conversations' collection
    match /conversations/{conversationId} {
        // A user can read/update a conversation if they are a participant
        allow get, update: if isAuthenticated() && request.auth.uid in resource.data.participantIds;
        
        // A user can create a conversation if they are one of the participants
        allow create: if isAuthenticated() && request.auth.uid in request.resource.data.participantIds;

        // Rules for 'messages' subcollection
        match /messages/{messageId} {
            // A user can read messages if they are part of the conversation
            allow get, list: if isAuthenticated() && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds;
            
            // A user can create a message if they are part of the conversation and are the sender
            allow create: if isAuthenticated() && 
                            request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds &&
                            isOwner(request.resource.data.senderId);
        }
    }
    
    // Rules for 'notifications' collection
    match /notifications/{notificationId} {
       // A user can read their own notifications
       allow get, list: if isAuthenticated() && isOwner(resource.data.userId);

       // A user can mark their own notifications as read
       allow update: if isAuthenticated() && isOwner(resource.data.userId) && request.resource.data.isRead == true;
       
       // Don't allow direct creation or deletion from client
       allow create, delete: if false;
    }
    
    // Rules for 'mail' queue collection
    match /mail/{mailId} {
      // Only allow server-side creation (callable functions)
      allow read, write: if false;
      // Allow authenticated users to add to the mail queue
      allow create: if isAuthenticated();
    }
  }
}