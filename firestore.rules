
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      // Anyone can read a user's profile
      allow read;
      
      // A user can only be created if they are the one making the request
      allow create: if request.auth != null && request.resource.id == request.auth.uid;
      
      // A user can only update their own document, and only specific fields
      allow update: if request.auth != null && request.auth.uid == userId 
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['name', 'bio', 'location', 'avatarUrl', 'friends', 'blockedUsers', 'fcmToken']);
    }

    match /posts/{postId} {
      allow read;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
      // Allow post owner to update their own post.
      // Allow any authenticated user to update only the likedBy, attendees, or commentCount fields.
      allow update: if request.auth != null && (
                      (request.auth.uid == resource.data.userId) ||
                      (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likedBy', 'attendees', 'commentCount']))
                    );
    }

    match /posts/{postId}/comments/{commentId} {
        allow read;
        allow create: if request.auth != null;
        // Allow user to update reactions, or the post author to delete the comment (by updating text)
        allow update: if request.auth != null && (
                        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions'])) ||
                        (get(/databases/$(database)/documents/posts/$(postId)).data.userId == request.auth.uid)
                      );
        allow delete: if request.auth != null && (
                        resource.data.userId == request.auth.uid ||
                        get(/databases/$(database)/documents/posts/$(postId)).data.userId == request.auth.uid
                      );
    }
    
    match /friend_requests/{requestId} {
        allow read, create, update, delete: if request.auth != null && request.auth.uid in resource.data.participantIds;
    }

    match /conversations/{conversationId} {
      allow read, create, update: if request.auth != null && request.auth.uid in resource.data.participantIds;
      match /messages/{messageId} {
        allow read, create: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds;
      }
    }

    match /businesses/{businessId} {
      allow get;
      allow list: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.ownerId == request.auth.uid;
    }
    
    match /notifications/{notificationId} {
        allow read, update: if request.auth != null && request.auth.uid == resource.data.userId;
    }
  }
}
